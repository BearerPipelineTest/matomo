{% extends inReportingMenu ? "empty.twig" : "admin.twig" %}

{% set title %}{{ 'Marketplace_Marketplace'|translate }}{% endset %}

{% block content %}

    <div class="marketplace" piwik-marketplace>

        <div piwik-content-intro>
            <h2 piwik-enriched-headline feature-name="{{ 'CorePluginsAdmin_Marketplace'|translate }}"
            >{{ title|e('html_attr') }}</h2>

            <p>
                {% if not isSuperUser %}
                    {% if showThemes %}
                        {{ 'Marketplace_NotAllowedToBrowseMarketplaceThemes'|translate }}
                    {% else %}
                        {{ 'Marketplace_NotAllowedToBrowseMarketplacePlugins'|translate }}
                    {% endif %}
                {% elseif showThemes %}
                    {{ 'CorePluginsAdmin_ThemesDescription'|translate }}
                    {{ 'Marketplace_InstallingNewPluginViaMarketplaceOrUpload'|translate(('CorePluginsAdmin_Themes'|translate), '<a href="#" class="uploadPlugin">', ('CorePluginsAdmin_Theme'|translate), '</a>')|raw }}
                {% else %}
                    {{ 'CorePluginsAdmin_PluginsExtendPiwik'|translate }}
                    {{ 'Marketplace_InstallingNewPluginViaMarketplaceOrUpload'|translate(('General_Plugins'|translate), '<a href="#" class="uploadPlugin">', ('General_Plugin'|translate), '</a>')|raw }}
                {% endif %}
                {% if isSuperUser and inReportingMenu %}
                    {{ 'Marketplace_NoticeRemoveMarketplaceFromReportingMenu'|translate('<a href="#" piwik-plugin-name="WhiteLabel">', '</a>')|raw }}
                {% endif %}
            </p>

            {% set defaultLicenseKeyFields %}
        <div piwik-field uicontrol="text" name="license_key"
             class="valign licenseKeyText"
             full-width="true"
             ng-model="licenseController.licenseKey"
             ng-change="licenseController.updatedLicenseKey()"
             placeholder="{% if isValidConsumer %}{{ 'Marketplace_LicenseKeyIsValidShort'|translate }}{% else %}{{ 'Marketplace_LicenseKey'|translate|e('html_attr') }}{% endif %}">
        </div>
        <div piwik-save-button
             class="valign"
             onconfirm="licenseController.updateLicense()"
             data-disabled="!licenseController.enableUpdate"
             value="{% if hasLicenseKey %}{{ 'CoreUpdater_UpdateTitle'|translate|e('html_attr') }}{% else %}{{ 'Marketplace_ActivateLicenseKey'|translate|e('html_attr') }}{% endif %}"
             id="submit_license_key"></div>
{% endset %}

<div class="marketplace-max-width" ng-controller="PiwikMarketplaceLicenseController as licenseController">
    <div class="marketplace-paid-intro">
    {% if isValidConsumer %}
        {% if isSuperUser %}
            {{ 'Marketplace_PaidPluginsWithLicenseKeyIntro'|translate('')|raw }}
            <br/>

            <div class="licenseToolbar valign-wrapper">
                {{ defaultLicenseKeyFields|raw }}

                <div piwik-save-button
                     class="valign"
                     id="remove_license_key"
                     onconfirm="licenseController.removeLicense()"
                     value="{{ 'Marketplace_RemoveLicenseKey'|translate|e('html_attr') }}"
                ></div>

                <a href="{{ linkTo({'action': 'subscriptionOverview'}) }}" class="btn valign">
                    {{ 'Marketplace_ViewSubscriptions'|translate }}
                </a>

                {% if isAutoUpdatePossible and isPluginsAdminEnabled and paidPluginsToInstallAtOnce|length %}
                    <a href="javascript:;" class="btn installAllPaidPlugins valign">
                        {{ 'Marketplace_InstallPurchasedPlugins'|translate }}
                    </a>
                    <div class="ui-confirm" id="installAllPaidPluginsAtOnce">
    <h2>{{ 'Marketplace_InstallAllPurchasedPlugins'|translate }}</h2>
    <p>
        {{ 'Marketplace_InstallThesePlugins'|translate }}
        <br /><br />
    </p>
    <ul>
        {% for pluginName in paidPluginsToInstallAtOnce %}
            <li>{{ pluginName }}</li>
        {% endfor %}
    </ul>

    <p>
        <input role="install" type="button" data-href="{{ linkTo({'action': 'installAllPaidPlugins', 'nonce': installNonce}) }}"
               value="{{ 'Marketplace_InstallAllPurchasedPluginsAction'|translate(paidPluginsToInstallAtOnce|length) }}">
        <input role="cancel" type="button" value="{{ 'General_Cancel'|translate }}"/>
    </p>
</div>

                {% endif %}

            </div>

            <div piwik-activity-indicator loading="licenseController.isUpdating"></div>
        {% endif %}

    {% else %}
        {% if isSuperUser %}
            {{ 'Marketplace_PaidPluginsNoLicenseKeyIntro'|translate("<a target='_blank' rel='noreferrer noopener' href='https://matomo.org/recommends/premium-plugins/'>", "</a>")|raw }}

            <br/>

            <div class="licenseToolbar valign-wrapper">
                {{ defaultLicenseKeyFields|raw }}
            </div>

            <div piwik-activity-indicator loading="licenseController.isUpdating"></div>

        {% else %}
            {{ 'Marketplace_PaidPluginsNoLicenseKeyIntroNoSuperUserAccess'|translate("<a target='_blank' rel='noreferrer noopener' href='https://matomo.org/recommends/premium-plugins/'>", "</a>")|raw }}
        {% endif %}

    {% endif %}
    </div>
</div>


<div class="ui-confirm" id="confirmRemoveLicense">
    <h2>{{ 'Marketplace_ConfirmRemoveLicense'|translate }}</h2>
    <input role="yes" type="button" value="{{ 'General_Yes'|translate }}"/>
    <input role="no" type="button" value="{{ 'General_No'|translate }}"/>
</div>


            {% include '@Marketplace/uploadPluginDialog.twig' %}

            <div
              vue-entry="Marketplace.Marketplace"
              plugin-type="{{ pluginType|default(null)|json_encode|e('html_attr') }}"
              plugin-type-options="{{ pluginTypeOptions|default(null)|json_encode|e('html_attr') }}"
              sort="{{ sort|default(null)|json_encode|e('html_attr') }}"
              plugin-sort-options="{{ pluginSortOptions|default(null)|json_encode|e('html_attr') }}"
              plugins-to-show="{{ pluginsToShow|default(null)|json_encode|e('html_attr') }}"
              query="{{ query|default(null)|json_encode|e('html_attr') }}"
              num-available-plugins="{{ numAvailablePlugins|default(null)|json_encode|e('html_attr') }}"
            ></div>
        </div>

        {% if pluginsToShow|length > 0 %}
    <div class="pluginListContainer row">
        {% for plugin in pluginsToShow %}
            <div class="col s12 m6 l4">
                {% embed 'contentBlock.twig' with {'title': ''} %}
                    {% block content %}
                        {% import '@Marketplace/macros.twig' as marketplaceMacro %}
                        {% import '@CorePluginsAdmin/macros.twig' as pluginsMacro %}
                        <div class="plugin">
                            <h3 class="card-title" title="{{ 'General_MoreDetails'|translate }}">
                                <a href="#" piwik-plugin-name="{{ plugin.name }}">{{ plugin.displayName }}</a>
                            </h3>

                            <p class="description">
                                {{ plugin.description }}
                                <a class="more" href="#" piwik-plugin-name="{{ plugin.name }}" title="{{ 'General_MoreDetails'|translate }}">
                                    &rsaquo; {{ 'General_MoreLowerCase'|translate }}</a>
                            </p>

                            {% if showThemes %}
                                {# Screenshot for themes #}
                                <a class="more" href="#" piwik-plugin-name="{{ plugin.name }}">
                                    <img title="{{ 'General_MoreDetails'|translate }}"
                                         class="preview" src="{{ plugin.screenshots|first }}?w=250&h=150"/></a>
                            {% endif %}

                            <ul class="metadata">
                                {% if plugin.isBundle is not defined or not plugin.isBundle %}
                                    <li>
                                        {% if plugin.latestVersion %}
                                            {{ 'CorePluginsAdmin_Version'|translate }}: {{ plugin.latestVersion }}
                                        {% endif %}

                                        {% if plugin.canBeUpdated %}
                                            <a class="update-available"
                                                {% if plugin.changelog is defined and plugin.changelog and plugin.changelog.url is defined and plugin.changelog.url %}
                                                    target="_blank" href="{{ plugin.changelog.url|e('html_attr') }}"
                                                {% else %}
                                                    href="#" piwik-plugin-name="{{ plugin.name }}"
                                                {% endif %}
                                               title="{{ 'Marketplace_PluginUpdateAvailable'|translate(plugin.currentVersion, plugin.latestVersion) }}">
                                                {{ 'Marketplace_NewVersion'|translate }}</a>
                                        {% endif %}
                                    </li>
                                    {% if plugin.lastUpdated %}
                                        <li>{{ 'Marketplace_Updated'|translate }}: {{ plugin.lastUpdated }}</li>
                                    {% endif %}
                                    {% if plugin.numDownloads %}
                                        <li>{{ 'General_Downloads'|translate }}: {{ plugin.numDownloads }}</li>
                                    {% endif %}
                                    <li>{{ 'Marketplace_Developer'|translate }}: {{ marketplaceMacro.pluginDeveloper(plugin.owner) }}</li>
                                {% endif %}
                            </ul>

                            {% macro moreDetailsLink(plugin) %}
                                {% set canBePurchased = not plugin.isDownloadable and plugin.shop is defined and plugin.shop and plugin.shop.url %}
                                <a class="btn btn-block plugin-details {% if canBePurchased %}purchaseable{% endif %}" href="#" piwik-plugin-name="{{ plugin.name }}" title="{{ 'General_MoreDetails'|translate }}">

                                    {% if canBePurchased and plugin.shop.variations %}
                                        {% set foundCheapest = 0 %}
                                        {% for variation in plugin.shop.variations %}
                                            {% if not foundCheapest and variation.cheapest is defined and variation.cheapest %}
                                                {% set foundCheapest = 1 %}
                                                {{ 'Marketplace_PriceFromPerPeriod'|translate(variation.prettyPrice, variation.period) }}
                                            {% endif %}
                                        {% endfor %}
                                        {% if not foundCheapest %}
                                            {{ 'Marketplace_PriceFromPerPeriod'|translate(plugin.shop.variations.0.prettyPrice, plugin.shop.variations.0.period) }}
                                        {% endif %}
                                    {% else %}
                                        {{ 'General_MoreDetails'|translate }}
                                    {% endif %}
                                    <span style="white-space: nowrap;">({{ 'Marketplace_FreeTrialLabel'|translate }})</span>
                                </a>
                            {% endmacro %}


                            {% if isSuperUser %}
                                <div class="footer">
                                    {% if plugin.isMissingLicense is defined and plugin.isMissingLicense %}

                                        <div class="alert alert-danger" >
                                            {{ 'Marketplace_LicenseMissing'|translate }}

                                            <span style="white-space:nowrap">(<a class="plugin-details" href="#" piwik-plugin-name="{{ plugin.name }}" title="{{ 'General_MoreDetails'|translate }}">{{ 'General_Help'|translate }}</a>)</span>
                                        </div>

                                    {% elseif plugin.hasExceededLicense is defined and plugin.hasExceededLicense %}
                                        <div class="alert alert-danger">
                                            {{ 'Marketplace_LicenseExceeded'|translate }}

                                            <span style="white-space:nowrap">(<a class="plugin-details" href="#" piwik-plugin-name="{{ plugin.name }}" title="{{ 'General_MoreDetails'|translate }}">{{ 'General_Help'|translate }}</a>)</span>
                                        </div>

                                    {% elseif plugin.canBeUpdated and 0 == plugin.missingRequirements|length and isAutoUpdatePossible %}
                                        <a class="btn btn-block"
                                           href="{{ linkTo({'module': 'Marketplace', 'action':'updatePlugin', 'pluginName': plugin.name, 'nonce': updateNonce}) }}">
                                            {{ 'CoreUpdater_UpdateTitle'|translate }}
                                        </a>
                                    {% elseif plugin.missingRequirements|length > 0 or not isAutoUpdatePossible %}
                                        {% macro downloadButton(showOr, plugin, isAutoUpdatePossible, showBrackets = false) -%}
                                            {%- if plugin.missingRequirements|length == 0 and plugin.isDownloadable and not isAutoUpdatePossible -%}
                                                {% if showBrackets %}({% endif %}<span onclick="$(this).css('display', 'none')">
                                                {%- if showOr %} {{ 'General_Or'|translate }} {% endif -%}
                                                <a class="plugin-details download"
                                                   href="{{ linkTo({'module': 'Marketplace', 'action': 'download', 'pluginName': plugin.name, 'nonce': (plugin.name|nonce)}) }}"
                                                >{{ 'General_Download'|translate }}</a></span>{% if showBrackets %}){% endif %}
                                            {%- endif -%}
                                        {%- endmacro %}

                                        {% if plugin.canBeUpdated and 0 == plugin.missingRequirements|length %}
                                            {{ 'Marketplace_CannotUpdate'|translate }}
                                            <span style="white-space:nowrap">(<a class="plugin-details" href="#" piwik-plugin-name="{{ plugin.name }}" title="{{ 'General_MoreDetails'|translate }}">{{ 'General_Help'|translate }}</a>{{ _self.downloadButton(true, plugin, isAutoUpdatePossible)|raw }})</span>
                                        {% elseif plugin.isInstalled %}
                                            {{ 'General_Installed'|translate }}
                                            {{ _self.downloadButton(false, plugin, isAutoUpdatePossible, true)|raw }}
                                        {% elseif not plugin.isDownloadable %}
                                            {{ _self.moreDetailsLink(plugin)|raw }}
                                        {% else %}
                                            {{ 'Marketplace_CannotInstall'|translate }}

                                            <span style="white-space:nowrap">(<a class="plugin-details" href="#" piwik-plugin-name="{{ plugin.name }}" title="{{ 'General_MoreDetails'|translate }}">{{ 'General_Help'|translate }}</a>{{ _self.downloadButton(true, plugin, isAutoUpdatePossible)|raw }})</span>
                                        {% endif %}

                                    {% elseif plugin.isInstalled %}
                                        {{ 'General_Installed'|translate }}

                                        {% if not plugin.isInvalid and not isMultiServerEnvironment and isPluginsAdminEnabled %}
                                            ({{ pluginsMacro.pluginActivateDeactivateAction(plugin.name, plugin.isActivated, plugin.missingRequirements, deactivateNonce, activateNonce) }})
                                        {% endif %}

                                    {% elseif plugin.isPaid and not plugin.isDownloadable %}
                                        {{ _self.moreDetailsLink(plugin)|raw }}
                                    {% else %}
                                        <a href="{{ linkTo({'module': 'Marketplace', 'action': 'installPlugin', 'pluginName': plugin.name, 'nonce': installNonce}) }}"
                                           class="btn">
                                            {{ 'Marketplace_ActionInstall'|translate }}
                                        </a>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="footer">
                                    {{ _self.moreDetailsLink(plugin)|raw }}
                                </div>
                            {% endif %}

                        </div>
                    {% endblock %}
                {% endembed %}
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if pluginsToShow|length == 0 %}
    <div piwik-content-block>
        {% if showThemes %}
            {{ 'Marketplace_NoThemesFound'|translate }}
        {% else %}
            {{ 'Marketplace_NoPluginsFound'|translate }}
        {% endif %}
    </div>
{% endif %}



        <div class="footer-message center">
            {{ 'Marketplace_DevelopersLearnHowToDevelopPlugins'|translate('<a target="_blank" rel="noreferrer noopener" href="https://developer.matomo.org/develop">', '</a>')|raw }}
            <br />
            <br />
            <br />
            <a rel="noreferrer noopener" href="https://shop.matomo.org/faq/" target="_blank">FAQ</a> |
            <a rel="noreferrer noopener" href="https://shop.matomo.org/terms-conditions/" target="_blank">Terms</a> |
            <a rel="noreferrer noopener" href="https://matomo.org/privacy-policy/" target="_blank">Privacy</a> |
            <a rel="noreferrer noopener" href="https://matomo.org/contact/" target="_blank">Contact</a>
        </div>

    </div>

{% endblock %}
